<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html>
<head><link rel=manifest href=/manifest.json>
  <meta charset="utf-8">
  
  <title>MXOXW</title>
  <meta name="author" content="Wind">
  
  <meta name="description" content="备注
目录本次答辩的目录如下，首先介绍下个人经历
自我介绍来腾讯之前是在京东，微信、手Q购物入口下的相关业务，主要工作是卖场活动，SNS活动的开发；产品类主要是一个社区产品——购物圈；后面部门战略调整，转为京喜事业部，做拼购的业务；
来腾讯之后，主要开发维护腾讯医生医生版，患者端小程序，医典、健康下问诊业务，目前主要工作是问诊相关业务；
目录问诊业务入口有多个渠道，有健康小程序版本，医典以及...">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta itemprop="image" content="//a.disquscdn.com/uploads/users/14817/5647/avatar92.jpg?1445168112" />
  <meta itemprop="name" content="MXOXW" />
  <meta itemprop="description" content="备注
目录本次答辩的目录如下，首先介绍下个人经历
自我介绍来腾讯之前是在京东，微信、手Q购物入口下的相关业务，主要工作是卖场活动，SNS活动的开发；产品类主要是一个社区产品——购物圈；后面部门战略调整，转为京喜事业部，做拼购的业务；
来腾讯之后，主要开发维护腾讯医生医生版，患者端小程序，医典、健康下问诊业务，目前主要工作是问诊相关业务；
目录问诊业务入口有多个渠道，有健康小程序版本，医典以及..." />
  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
  <link rel="dns-prefetch" href="//cdn.bootcss.com">

  <link rel="canonical" href="http://www.mxoxw.com/cv/index.html">
  
  <link rel="alternative" href="/atom.xml" title="MXOXW" type="application/atom+xml">
  
  
  
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
  <!--<link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">-->
  <!--<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">-->
  <!--<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">-->
  
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-4817791179797310",
      enable_page_level_ads: true
    });
  </script>
  
</head>

<body> <!-- TODO body 添加样式-->
  <header role="banner"><hgroup>
  <h1><a href="/">MXOXW</a></h1>
  
    <h2>Life always finds a way.</h2>
  
</hgroup>
</header>
  <nav role="navigation"><!-- TODO  -->
<ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
</ul>
  
<form action="https://www.google.com" target="_blank" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="http://www.mxoxw.com">
    <input class="search" type="text" name="q" results="0" placeholder="搜索..."/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li><li><a href="/archives/">博文列表</a></li><li><a href="/about/">关于</a></li>
</ul>


</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <p>备注</p>
<h3 id="目录">目录</h3><p>本次答辩的目录如下，首先介绍下个人经历</p>
<h3 id="自我介绍">自我介绍</h3><p>来腾讯之前是在京东，微信、手Q购物入口下的相关业务，主要工作是卖场活动，SNS活动的开发；产品类主要是一个社区产品——购物圈；后面部门战略调整，转为京喜事业部，做拼购的业务；<br>来腾讯之后，主要开发维护腾讯医生医生版，患者端小程序，医典、健康下问诊业务，目前主要工作是问诊相关业务；</p>
<h3 id="目录-1">目录</h3><p>问诊业务入口有多个渠道，有健康小程序版本，医典以及QQ浏览器，OPPO，华为快应用等的H5版本；从形态上分有小程序和H5版本；<br>随着业务的发展，小程序与H5的业务越来越统一，后续的业务通常会在各个渠道同步，而且H5版本最初是由外包做的，疫情期间，时间紧任务重，沟通成本也高，存在很多问题。有不少隐患，所以在业务空窗期做了一次重构</p>
<h3 id="H5问诊重构">H5问诊重构</h3><ul>
<li>使用了TS，但是没有利用起来TS的优势，反而增加了负担</li>
<li>引入了element-ui mint-ui两个UI组件库，但是实际使用场景并不多，额外增加了包大小</li>
<li>缺少异常处理，很多场景都只处理了正常逻辑，没有异常流程</li>
<li>登录这种公共的逻辑都没有统一处理，都是分散在各个具体业务代码里</li>
<li>性能问题，（包大小资源大，图片全都加载的大图，列表切换重新加载、没有缓存）</li>
</ul>
<p>针对以上问题，以及业务统一的背景，为了更好满足业务需求，确定了同构的想法，希望能够一套代码，多端运行（目前是只有小程序跟H5）；<br>优化代码的同时，进一步提升开发效率；</p>
<h3 id="思路">思路</h3><p>大概思路如下<br>方案选型<br>整体架构的设计<br>解决重构中的问题<br>效率提升，这个主要是组件优化</p>
<h3 id="方案选择">方案选择</h3><p>基于目前健康项目的现状，问诊作为子仓库引入，无法做出太大的改动，考虑同构方向是将小程序代码转换为H5，<br>目前业界的主要方案，uniapp跟taro，二者的案例都比较多，社区也都比较活跃<br>技术栈都支持Vue，跟目前的开发体检都匹配<br>在跨端维度上，uniapp相对更广，有对APP的支持；而taro主要针对的是各种小程序以及H5和快应用；<br>在小程序支持能力上，基本能力都支持，taro在wxs的使用上有限制，不支持使用 WXS 函数响应事件；<br>Uniapp是直接支持mpvue的，这点比较方便，<del>Taro next的优势在于解决小程序包大小的问题；</del><br>所以本次确定使用uniapp进行重构，以便更好的复用健康下问诊代码</p>
<h3 id="架构实现">架构实现</h3><p>重构进行之前呢，针对之前代码结构混乱，层次不清的问题，而且代码需要跨端运行，做了代码层面的相关规范，<br>整体架构如下：<br>业务层处理具体业务<br>统一封装平台差异化的公共方法<br>通过静态编译引入对应平台的公共方法</p>
<h3 id="业务层面只处理业务逻辑">业务层面只处理业务逻辑</h3><p>坚持一个原则：业务层面只处理业务逻辑（业务侧调用封装好的导航，支付等公共方法，不处理平台差异）</p>
<p>对于H5与小程序差异化的API，通过建立两套util，暴露一致的api，来抹平差异<br>包括storage，navigate，login，支付逻辑</p>
<p>对于一些没有平台差异的工具方法，像格式化类的方法，只维护一套，不同平台只做一个导入导出操作，达到复用效果</p>
<p>这样一来，业务代码更加简洁，业务层屏蔽差异,不需要关心具体实现，重点关注业务处理，也方便后续新人上手；<br>统一调用，相当于有了切面层，可以统一处理登录，参数透传等公共逻辑；存储区分环境，避免测试，预发布，正式环境的缓存交叉影响；<br><del>维护过健康，医典的小程序代码，基本上各自为政，公共方法的调用上也不统一，交叉维护困难，如果这种方式效果比较好的话，后面也可以推广到大组里，减少沟通成本，提升开发效率；</del></p>
<p>另外，Navigate里加入了路径映射；引用的子仓库导致新的路径跟现有H5不匹配；而H5早已经投放出去了，不能修改链接，需要做一个映射才能查找到对应的路由；还加入了登录鉴权，跳转的时候，如果目的页面需要强登录，会自动检查登录态，需要强登录的会直接跳转登录页面，业务侧不用作登录态判断，减少业务开发的工作量</p>
<h3 id="遇到问题">遇到问题</h3><p>重构中主要存在两个问题<br>rpx样式编译的问题，<br>监控上报的优化</p>
<h3 id="样式问题">样式问题</h3><p>窗口尺寸改变之后，元素大小不能自动变化来适应窗口尺寸；</p>
<p>小程序下样式使用的大小单位是rpx，uniapp在转成H5的时候，会转成成px绝对大小；不能自适应；<br>有两个解决方案，一是写脚本将样式文件中rpx替换为rem，都用相对大小；二是webpack编译时转换，样式处理时添加自定义loader，将rpx转换为rem，这种方式更加方便合理，可以直接采用视觉稿给出的大小，不需要转换了；<br>而对于在页面上通过style属性添加的样式，提供utils.rpx2rem工具方法去转换；</p>
<h3 id="监控上报">监控上报</h3><p>项目上线都需要对线上运行情况进行监控，收集错误信息。开始的时候，整个项目缺少监控上报，线上有问题也感知不到；当时aegis在推广使用，对业务侵入性小，就使用了aegis来做监控；<br>Aegis上报，只有3个方法，report，info，infoAll，不支持日志类型设置，只能在beforeReport钩子里对上报信息进行拦截处理；而beforeReport拿到的是纯文本信息，需要添加标识来解析日志类型，开始时aegis上报方法只支持一个参数，如果要上报多个对象，就需要业务侧自己处理对象序列化，还要解决对象有嵌套引用的情况，所以提交一个PR去支持多参数的上报，能够提升开发的效率；</p>
<p>Info跟infoall方法是上报正常日志，用来辅助定位问题的，区别是infoall全量上报，info只上报白名单用户；没有采用aegis的白名单配置，使用了infoall全量上报，通过运营位控制上报比例的方式来控制成本；<br>另外还有些无需上报的日志，比如SDK里的一些接口上报，需要过滤；这块只能通过黑名单的方式过滤；起初是每次修改黑名单规则，跟随版本发布，时效性不高，后面采用了本地缓存，运营位异步更新的方式去配置黑名单，可以及时屏蔽非必要告警；</p>
<p>=======<br>监控告警上线之后，辅助定位排查出多个问题，比如retcode上报了一些场景下的接口调用参数错误，异常上报（badjs）了一些分支流程里代码运行时的错误，以及后期在小程序消息授权问题定位排查，和线上修复验证时，提供了很大帮助，借助aegis提供的api，每天定时扫描线上的日志信息，及时获取运行情况</p>
<h3 id="效率提升">效率提升</h3><p>效率提升</p>
<h3 id="公共组件">公共组件</h3><p>在重构过程中，抽出了一些公共组件，快速问诊/AI 导诊下患者输入，及选择控件，首页的科室以及推荐科室落地页，找医生页面下的医生列表组件</p>
<p>医生列表组件相交之前，添加了缓存，避免切换条件后重复查询，loading动效以及加载失败重试，格式化图片，利用CDN的图片处理能力，减小图片尺寸；</p>
<p><del>找医生页面还缓存筛选条件接口，科室，医院等级，医生职称，这些筛选条件都是长期不变的，可以进一步减少首屏的接口查询数量</del></p>
<h3 id="性能对比">性能对比</h3><p>本次重构前后的一些对比<br>整个包大小由5.2M减少到2.9M</p>
<h3 id="性能对比-1">性能对比</h3><p>医生列表页面是PV最多的一个页面，通过组件内对图片的优化处理，有效降低了资源的请求大小<br>首屏的图片资源由8.8M减少到170k</p>
<h3 id="H5问诊重构-1">H5问诊重构</h3><p>本次重构的收获</p>
<p>重构后收益最大的方面，应该是在开发成本上，之前健康小程序里快速问诊开发是3天，重构之后，从健康迁移过来只用了1天，只有一个H5下支付的适配工作，一个原因是不需要重构介入了，再一个代码可以直接复用</p>
<h3 id="目录-2">目录</h3><p>重构之后呢，流水线需要变更，而且之前的流水线也存在一些问题，也趁此时机对流水线做了优化，主要有以下几个方面</p>
<h3 id="CI流程优化">CI流程优化</h3><p>测试环境变更比较频繁，追求时效性，开始的时候，代码提交之后，等生效可能要等五六分钟；<br>原因是存在一些问题，流水线缓存设置有问题，npm安装包没有缓存，每次都会重新安装；<br>容器的基础镜像比较大，使用的CSIG推荐的基础镜像，包含一些安全软件，编译完成之后有4.5G；但在测试环境内网访问，这种就没有必要了，所以替换成了官方最小的NGINX镜像，编译后有25M；<br>再一个，dockerfile的编写存在问题，之前的copy命令最先执行，导致每次都是全新编译，后面将copy命令放到最后，之前的命令都会读缓存；<br>而且之前copy的是整个项目，包含了npm包，增加了耗时，现在通过.dockerignore配置忽略掉所有没必要拷贝的文件；<br>整体优化下来，现在的流水线速度大概是1分半；测试期间，流水线每天会跑十几次，能够有效提高开发测试验证的效率</p>
<h3 id="CI流程优化-1">CI流程优化</h3><p>而针对预发布已及正式环境，外网能够访问，不能像测试环境一样随意了，依然使用推荐的基础镜像；发布流水线追求的不再是速度上的提升，因为只在发布的时候，运行两三次；<br>而是结合现有的git开发流程以及发布规范，在流水线前后分别增加了检查是否合并最新develop分支，校验不通过会直接终止执行，发布后提交MR将release分支合入develop分支；保证流程的正常执行；（以前存在过发布后，release分支没有合并的情况，在下次拉取release分支的时候才想起来，现在从流程上就避免了这种问题）</p>
<p><code>git merge-base $merge_destination_branch origin/develop</code></p>
<h3 id="目录-3">目录</h3><p>下面是专业贡献</p>
<h3 id="专业贡献">专业贡献</h3><p>人才培养方面，外包同学彭一鸣，oms系统后端用node部署，node使用上的一些指导</p>
<p>文档工具方面，vscode使用上主要是结合git，一些效率提升方面的介绍<br>扫码报道的问题：前面提到过，当时小程序长期订阅消息存在概率性触发bug；有两个解决方案，为了快速解决验证，就使用了运营位控制灰度比例，在线上验证的方式；验证之后，直接修改运营位配置，采用正确的解决方案<br>运营位可视化配置工具，现在的配置方式是编码的方式，可视化配置能够提升配置效率，<del>后面有时间直接集成到oms上，方便使用</del></p>
<h3 id="谢谢">谢谢</h3><p>以上是本次答辩内容，谢谢大家</p>
<h3 id="未来规划">未来规划</h3><p>短期<br>进一步调整aegis监控上报</p>
<p>长期<br>Uniapp在APP上的应用<br>Webpack5实践</p>

  
</article>


  <section>
    <h1>评论</h1>
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<!--<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>-->
<script src="/js/gitalk.min.js" type="text/javascript"></script>

<script type="text/javascript">
      var gitalk = new Gitalk({
        clientID: '50fbdf7a6156260cd0b1',
        clientSecret: 'aeac1ce266e68e5421cdbbcc9b5223378ff0b6bc',
        repo: 'gitalk',
        owner: 'wolfsilver',
        admin: 'wolfsilver',
        id: location.pathname.substring(0, 50),
        labels: 'Gitalk'.split(','),
        perPage: 15,
        pagerDirection: 'last',
        createIssueManually: true,
        distractionFreeMode: false
      })

      gitalk.render('gitalk-container')
 </script>
  </section>

</div>


  <aside class="sidebar">
    
      
<section>
  <h1>分类</h1>
  <ul id="categories">
    
      
        <li class="category"><a href="/categories/essay/" title="Essay">Essay (1)</a></li>
      
    
      
        <li class="category"><a href="/categories/java/" title="Java">Java (3)</a></li>
      
    
      
        <li class="category"><a href="/categories/javascript/" title="JavaScript">JavaScript (5)</a></li>
      
    
      
        <li class="category"><a href="/categories/whistle-js/" title="whistle js">whistle js (1)</a></li>
      
    
      
        <li class="category"><a href="/categories/其他/" title="其他">其他 (1)</a></li>
      
    
      
        <li class="category"><a href="/categories/前端/" title="前端">前端 (5)</a></li>
      
    
      
        <li class="category"><a href="/categories/java/多线程/" title="多线程">多线程 (1)</a></li>
      
    
      
        <li class="category"><a href="/categories/杂谈/" title="杂谈">杂谈 (2)</a></li>
      
    
      
        <li class="category"><a href="/categories/转载/" title="转载">转载 (2)</a></li>
      
    
  </ul>
</section>


    
      
<section>
  <h1>近期文章</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/b/2019/12/whistle-xxtpl/">whistle.xxtpl</a>
      </li>
    
      <li class="post">
        <a href="/b/2018/11/2018-11-01-mian-shi/">2018-11-01面试</a>
      </li>
    
      <li class="post">
        <a href="/b/2018/08/2018-nian-8-yue-25-ri-mian-shi/">2018年8月25日 面试</a>
      </li>
    
      <li class="post">
        <a href="/b/2018/02/duo-yu-ming-dan-zheng-shu/">多域名单证书</a>
      </li>
    
      <li class="post">
        <a href="/b/2018/01/vs-code-zi-ding-yi-gao-liang/">VS Code自定义高亮</a>
      </li>
    
  </ul>
</section>


    
  </aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Wind -
  <span class="credit">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></span>
</p>
</footer>
  <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
<script src="//cdn.bootcss.com/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.7.1/clipboard.min.js" type="text/javascript"></script>
<script src="/js/script.min.js" type="text/javascript"></script>





  <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">
  <script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" type="text/javascript"></script>



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-60526602-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-60526602-1');
</script>

<!-- End Google Analytics -->



<!-- Baidu Analytics -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?f09124d228ae25c45c871424139d9ca9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<!-- End Baidu Analytics -->




<script>if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js?t=1614136294983')
    .then(function () {console.log('ServiceWorker Register Successfully.')})
    .catch(function (e) {console.error(e)});
}
</script></body>
</html>
